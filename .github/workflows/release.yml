name: Release

on:
  push:
    branches: ["main", "arm-build"]
    tags: [ v* ]
  # pull_request:
  #   types: [ opened, synchronize, reopened ]
  workflow_dispatch:


# this is needed for getting the github token from the organization's oauth
# app. see: tibdex/github-app-token
permissions:
  id-token: write
  contents: read

jobs:

  release:
    runs-on: ubuntu-latest
    name: "Release"
    env:
      AWS_REGION: eu-central-1
      APP_VERSION: ${{ github.ref_type == 'tag' && github.ref_name || github.event.pull_request.head.sha || github.sha  }}
      # ARTIFACTS_BUCKET: priceloop-build-artifacts-nocode
      DOCKER_IMAGE: priceloop/nocode-postgres
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      # https://github.com/docker/setup-qemu-action
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      # https://github.com/docker/setup-buildx-action
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v2

      - name: Generate github token
        id: generate-token
        uses: tibdex/github-app-token@v1
        with:
          app_id: ${{ secrets.GH_APP_ID }}
          private_key: ${{ secrets.GH_PRIVATE_KEY }}

      - name: Build and Publish Docker Images
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u USERNAME --password-stdin
          docker buildx build \
            --platform linux/arm64,linux/amd64 \
            --tag ghcr.io/${DOCKER_IMAGE}:${APP_VERSION} \
            --label "org.opencontainers.image.source=https://github.com/priceloop/nocode-postgres" \
            --label "org.opencontainers.image.description=Postgres Image for Nocode" \
            --label "org.opencontainers.image.licenses=MIT" \
            --push

#      - name: Build and push
#        uses: docker/build-push-action@v2
#        with:
#          context: .
#          platforms: linux/amd64,linux/arm64
#          push: true
#          tags: ${{ steps.prep.outputs.tags }}



        # docker push ${ECR_URL}/${POSTGRES_REPOSITORY}:${APP_VERSION}

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3

